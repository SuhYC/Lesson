# 저장 프로시저
일련의 쿼리를 하나의 함수처럼 실행하기 위한 쿼리들의 집합이다. <br/>

### 특징
1. 재사용 가능
- 한 번 작성한 저장프로시저는 여러번 호출하여 사용할 수 있다.
2. 성능 향상
- 저장프로시저는 데이터베이스 서버에서 미리 컴파일되어 실행속도가 빠르다.
- 클라이언트-서버 간 데이터전송을 줄일 수 있어 효율적이다.
3. 보안 강화
- 사용자가 직접적으로 SQL 접근하는 것을 제한할 수 있다.
- SQL인젝션 공격을 방어하는데 도움을 준다.
4. 논리 캡슐
- 복잡한 로직을 캡슐화하여 응용프로그램 코드와 분리할 수 있다.
- 데이터베이스 변경사항이 있을 때 저장프로시저만 수정하면 된다.

### 저장프로시저의 장점
```SQL
SELECT * FROM TABLE WHERE ID = 1;
```
```SQL
SELECT * FROM TABLE WHERE ID = 2;
```
```SQL
SELECT * FROM TABLE WHERE ID = 3;
```
위 세 쿼리는 T-SQL의 실행과정 중 동일한 쿼리로 인정되지 않는다. ```1;```, ```2;```, ```3;```부분이 다르기 때문이다.

```SQL
CREATE PROCEDURE GetInfo
  @ID INT
AS
BEGIN
  SELECT * FROM TABLE WHERE ID = @ID;
END;
```
위 저장프로시저를 생성하고, 다음 요청을 하는 경우를 생각해보자.

```SQL
EXEC GetInfo @ID = 1;
```
```SQL
EXEC GetInfo @ID = 2;
```
```SQL
EXEC GetInfo @ID = 3;
```
위 3가지 요청은 매개변수만 다르기 때문에 실행 계획을 재사용하여 컴파일 비용을 줄일 수 있다.

### 저장프로시저 사용시 주의사항
저장프로시저의 실행계획은 초기 실행 때 생성된 것으로 재사용될 수 있다. <br/>
초기 실행에 인덱스 사용 여부가 결정되는데, 인덱스 사용이 오히려 성능 저하를 불러오는 경우가 있다. <br/>
첫번째 실행에 데이터를 적게 가져오도록 파라미터가 설정되어 인덱스를 사용하도록 최적화되어 컴파일 된 경우 <br/>
두번째 실행에 많은 데이터를 가져오도록 파라미터가 설정되어, <br/>
인덱스를 사용하는 것이 불리하더라도 초기실행에 설정된 실행계획대로 인덱스를 사용할 것이다.<br/>

물론 인덱스 사용 여부가 불분명하다면, ```WITH RECOMPILE```을 포함하여 다시 컴파일 하도록 설정할 수도 있다.
