# virtual
## 클래스의 상속
C++은 클래스의 상속 기능을 제공하며, 상속관계에 있는 메소드는 재정의가 가능하다.<br/>
이 때, 클래스의 다형성 때문에 부모클래스 포인터에 저장된 자식클래스 인스턴스의 함수를 요청하면, 자식클래스의 함수가 아닌 부모클래스의 함수가 호출되는데,<br/>
이를 방지하고 자식클래스의 함수가 올바르게 실행되도록 하려면 virtual키워드와 override키워드가 필요하다.<br/>

## virtual 키워드를 사용하면 일어나는 일
1. virtual키워드를 사용함으로서 가상함수테이블이 작성된다.

가상함수테이블에는 override된 함수 정보가 담긴다.<br/>
동적바인딩을 사용하여 런타임에 적절한 함수를 선택할 수 있도록 한다.

2. 클래스의 인스턴스의 크기가 조금 증가한다.

정확히는 각 프로세서의 처리단위 만큼의 크기가 증가한다.<br/>
64비트 프로세서의 경우는 8바이트의 크기가 증가한다.<br/>
이는 가상함수의 갯수와 상관없이 1개의 가상함수만 있어도 동일한 크기가 증가한다.<br/>
이는 각 함수의 주소를 각 인스턴스가 모두 가지고 있는 것이 아니고 가상함수테이블이 각 함수의 주소를 가지고 있으며,<br/>
각 인스턴스는 가상함수테이블의 주소를 가지고 있기 때문이다.

```cpp
class A
{
public:
  int i; // 4bytes -> + 4bytes padding
  double d; // 8bytes

  virtual void Func1() {}; // vptr : 8bytes on 64bits processor
  virtual void Func2() {}; // already has vptr.
}
```

위 코드의 클래스 A는 24bytes의 인스턴스 크기를 갖는다.<br/>
double형 변수 8바이트, 가상함수포인터 8바이트, int형 변수 4바이트. 그리고 64비트프로세서이기에 8바이트에 맞추어 int형 변수 옆에 4바이트의 패딩이 붙는다.

## 소멸자에서의 virtual
앞서 부모클래스 포인터에 자식클래스의 인스턴스를 담는다면, virtual 키워드를 붙이지 않은 함수는 부모클래스의 함수가 호출된다고 이야기했다.<br/>
이는 소멸자에서도 마찬가지인데, 소멸자에 virtual키워드를 붙이지 않은 채로 부모클래스 포인터에 담긴 자식클래스 데이터를 delete하게 되면, 부모클래스의 소멸자가 호출된다.<br/>
부모클래스와 자식클래스의 소멸자 내용이 다를 수 있고, 자식클래스에 맞는 소멸자가 호출되어야 메모리관리를 적절히 할 수 있을 것이다.<br/>
물론 자식클래스의 소멸자가 별다른 동작을 하지 않는다면 인스턴스의 크기를 줄이기 위해 virtual선언을 빼버린다는 생각을 할 수도 있다.<br/>
하지만 유지보수의 측면에서 볼 때, 언제 어느 자식클래스의 소멸자가 변동될지 모르기도 하고, 일관성을 위해서도 통일하는 것이 좋을 것이다.<br/>
그러므로 상속관계를 갖는 클래스의 소멸자는 virtual로 선언하는 것이 바람직하다.

### 그 외
1. virtual 키워드로 선언된 함수는 자식클래스의 override된 함수도 virtual이 적용된다.<br/>
오버라이드한 메소드에 virtual 키워드를 붙여도 되지만, 이러면 중복코드다.
2. override 키워드는 생략해도 되지만 작성하는 것을 권장한다.<br/>
추후 유지보수 단계에서 부모클래스에 있는 메소드를 override하지 않고 virtual 메소드를 새로 정의하는 실수를 막기 위함.<br/>
특히 부모클래스의 가상함수와 자식클래스의 함수가 매개변수를 다르게 선언하는 경우에 발생한다.<br/>
만약 부모클래스의 가상함수는 매개변수 double로, 자식클래스의 함수는 매개변수 int로 선언한 경우,<br/>
override 키워드를 자식클래스의 함수에 붙여주지 않았다면 이는 다른 함수로 판단하게 되며,<br/>
부모클래스포인터에 자식클래스의 인스턴스를 넣고 해당 함수를 double매개변수로 요청하게 되면 부모클래스의 함수가 실행된다.<br/>
하지만 override 키워드를 붙였다면, 이는 같은 함수이나 매개변수가 다르게 입력된 것으로 컴파일러가 판단하여 컴파일 에러가 발생하게 된다.<br/>
