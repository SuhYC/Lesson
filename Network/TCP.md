# Transmission Control Protocol (TCP)
L4의 프로토콜. <br/>
신뢰성을 중심으로 송신할 때 사용하는 프로토콜이다. <br/>

## 연결지향
통신을 시작할 때 반드시 3-way handshake로 연결을 설정함. <br/>
반대로 통신이 끝나면 4-way handshake로 안전하게 연결을 종료함. <br/>

### 3-way handshake
TCP통신을 시작하기 전 수행하는 3단계의 연결과정. <br/>
1. 커넥터의 입장에서 SYN플래그가 켜진 패킷으로 자신의 초기 시퀀스 넘버(ISN:Initial Sequence Number)를 전달.
2. 액셉터의 입장에서 확인 후, SYN, ACK플래그가 켜진 패킷으로 액셉터의 초기 시퀀스 넘버를 전달.
3. 커넥터가 확인 후 ACK 플래그가 켜진 패킷을 전달하며 연결 수립.

#### ISN이 왜 필요할까?
자신이 다음에 보낼 패킷의 번호를 지정해서 전송 데이터의 순서를 보장하고, <br/>
타인이 TCP 세션 하이재킹 같은 공격을 시도하는 것을 방지하기 위함. <br/>

### 4-way handshake
TCP통신을 종료하기 전 수행하는 4단계의 연결종료과정. <br/>
1. 능동적 종료자가 연결을 종료하기 위해 더 이상 송신할 메시지가 없음을 의미하는 FIN 플래그가 켜진 패킷을 송신.
2. 수동적 종료자가 FIN 패킷을 수신하고, 더 이상 수신할 메시지가 없음을 확인하고 ACK를 송신.
3. 수동적 종료자도 더 이상 송신할 메시지가 없으면 FIN 플래그가 켜진 패킷을 송신.
4. 능동적 종료자가 FIN 패킷을 수신하고, ACK 패킷을 송신 후 TIMEWAIT 상태 돌입.

#### 4-way handshake를 수행하는 이유
TCP는 양방향 독립적으로 송신이 가능하다. <br/>
한 쪽이 송신을 마쳤더라도 다른 한 쪽이 송신을 마칠 때까지 기다려야한다. <br/>
연결을 시작할 때는 상대의 연결 신호를 받은 경우 자신의 연결을 시작하면서 동시에 ACK를 송신할 수 있으니 3단계이나, <br/>
연결을 종료할 때는 상대의 연결 종료 신호를 받더라도 자신의 송신이 끝나지 않았을 수 있으니 동시에 FIN을 보낼 수 없는 것. <br/>

#### TIMEWAIT
4번 단계에서 능동적 종료자가 ACK패킷을 송신했더라도 패킷이 소실될 우려가 있다. <br/>
그러므로 3단계에서의 FIN 패킷에 대한 ACK를 수신하지 못한 수동적 종료자는 다시 FIN 패킷을 재전송할 것이고, <br/>
재전송되는 FIN 패킷을 기다릴 수 있는 충분한 시간을 얻기 위해 TIMEWAIT를 진입하는 것이다. <br/>
또한, 연결이 종료되고도 네트워크 상에서 아직 돌아다니고 있는 FIN패킷과 ACK패킷이 다음 연결에 영향을 줄 수 있으니, <br/>
이전 연결에 대한 패킷이 모두 수명을 다해 더 이상 유효한 패킷이 아니게 될 때까지 기다리는 효과를 주어<br/>
이전 연결에 대한 패킷이 새로운 연결에 혼동을 주지 않게 하는 효과가 있다.

### 재전송
연결과 연결종료 과정에서 보았던 ACK패킷과 같이, <br/>
예상되는 시퀀스 넘버의 패킷이 수신되면 다음으로 예상하는 시퀀스 넘버를 포함한 ACK 패킷으로 응답. <br/>
하지만 송신한 패킷에 대한 ACK 패킷이 TIMEOUT까지 도달하지 못하면, <br/>
해당 패킷이 소실된 것으로 간주하고 재전송함.

### 순서보장
수신측에서는 연결수립에 결정되었던 ISN을 기반으로 다음 시퀀스 넘버를 기대하고 수신함. <br/>
방금까지 수신한 패킷이 5번이었다면, 다음 패킷은 6번 패킷이 도달해야하는데, <br/>
만약 6번 패킷이 도달하지 않고 7번 패킷이 도달한다면, <br/>
다음으로 도착할 것으로 기대하는 패킷의 번호를 포함해 ACK 응답함. <br/>
만약 6번이 도달하지 않고 7번, 8번, 9번 패킷까지 도달한다면 6번 패킷을 기대하는 ACK가 3번 요청이 될 것이고, <br/>
이는 송신측에서도 이상함을 감지하고 Fast Retransmit 알고리즘을 이용해 해당 세그먼트를 재전송함. <br/>

## Nagle 알고리즘
아직 ACK를 수신하지 못한 패킷이 있을 때, ACK를 수신하기 전까지 MSS 이하의 데이터는 송신을 지연시키고 버퍼에 모으는 알고리즘. <br/>
네트워크 상의 혼잡성을 낮추는 효과가 있고, 송신헤더가 차지하는 비율을 줄이는 효과를 가지고 있다. <br/>
하지만 송신이 지연된다는 것은 반응성이 떨어진다는 의미이므로 응답성이 중요한 서버인 경우 해당 옵션을 해제한다.

## HeartBeat
메시지 외에도 해당 연결이 아직 유효한지를 판단하는 알고리즘. <br/>
지속적으로 연결을 확인하는 패킷을 보내, 응답을 수신하지 못하면 연결을 조기종료한다. <br/>
물론 해당 옵션을 켜지 않았더라도 일정 횟수 이상 재전송이 반복되면 커널에서 해당 연결이 종료되었음으로 간주하고 연결을 종료한다.
